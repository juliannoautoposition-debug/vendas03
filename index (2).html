<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>APP | Estoque | Hist√≥rico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{ --verde:#3f1e00; --fundo:#f8f9fa; }
    body{ background:var(--fundo); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .navbar{ background:var(--verde)!important; position: relative; }
    .navbar .nav-link,.navbar-brand{ color:#fff!important; }
    .img-side{ width:110px; height:90px; display:flex; align-items:center; justify-content:center; background:#fff; border-radius:8px; overflow:hidden; border:1px solid rgba(0,0,0,0.04); }
    .img-side img{ max-width:100%; max-height:100%; object-fit:contain; }
    .card-product{ border-radius:10px; transition: transform 0.2s, box-shadow 0.2s; }
    .card-product:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15)!important; }
    .small-muted{ font-size:.9rem; color:#6c757d; }
    .quantidade-controle{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center; }
    .quantidade-controle .btn-menos,.quantidade-controle .btn-mais{ width:34px; height:34px; padding:0; border-radius:6px; color:#fff; border:none; display:inline-flex; align-items:center; justify-content:center; font-size:1.2rem; font-weight:bold; }
    .btn-menos{ background:#dc3545; } .btn-mais{ background:#28a745; }
    .quantidade-controle input{ width:60px; height:34px; text-align:center; border-radius:6px; border:1px solid #ddd; }
    .btn-add{ background:#ffc107; color:#000; border-radius:8px; font-weight:600; height:40px; min-width:120px; display:inline-flex; align-items:center; justify-content:center; gap:8px; border:none; }
    .btn-add:hover{ background:#e0a800; }
    .card-estoque{ border-radius:10px; transition: transform 0.2s, box-shadow 0.2s; }
    .card-estoque:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15)!important; }
    .img-estoque{ width:80px; height:70px; display:flex; align-items:center; justify-content:center; background:#fff; border-radius:8px; overflow:hidden; border:1px solid rgba(0,0,0,0.08); flex-shrink:0; }
    .img-estoque img{ max-width:100%; max-height:100%; object-fit:contain; }
    .estoque-info{ flex:1; min-width:0; }
    .estoque-info h6{ margin:0 0 8px 0; font-size:1rem; font-weight:600; color:#212529; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .estoque-preco{ font-size:0.95rem; color:#6c757d; margin-bottom:4px; }
    .estoque-preco b{ color:#198754; font-size:1.05rem; }
    .estoque-qtd{ font-size:0.9rem; color:#6c757d; }
    .estoque-acoes{ display:flex; gap:6px; flex-shrink:0; }
    .btn-icon{ width:36px; height:36px; border-radius:6px; border:none; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s; }
    .btn-edit{ background:#0d6efd; color:#fff; } .btn-delete{ background:#dc3545; color:#fff; }
    .modal-sucesso{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center; }
    .modal-sucesso.show{ display:flex; animation: fadeIn 0.3s; }
    .modal-sucesso-content{ background:#fff; border-radius:20px; padding:40px; text-align:center; max-width:400px; margin:20px; animation: slideUp 0.4s; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
    .check-animation{ width:80px; height:80px; border-radius:50%; background:#198754; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; animation: scaleIn 0.5s; }
    .check-animation i{ color:#fff; font-size:40px; }
    @keyframes fadeIn{ from{opacity:0;} to{opacity:1;} } @keyframes slideUp{ from{transform:translateY(50px);opacity:0;} to{transform:translateY(0);opacity:1;} } @keyframes scaleIn{ 0%{transform:scale(0);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }
    .whatsapp-config{ margin-top:20px; padding:15px; background:#f0f0f0; border-radius:8px; }
    @media(max-width:767px){ .img-side{width:70px;height:60px;} .quantidade-controle input{width:50px;} .btn-add{width:100%;margin-top:8px;} .img-estoque{width:60px;height:55px;} .card-product .col-auto{width:100%;} .quantidade-controle{justify-content:flex-start;} .modal-sucesso-content{padding:30px 20px;} .check-animation{width:60px;height:60px;} .check-animation i{font-size:30px;} .navbar-nav{flex-direction:row;gap:5px;} .navbar-nav .nav-link{font-size:0.85rem;padding:8px!important;} .estoque-acoes{margin-top:8px;} h4{font-size:1.3rem;} .container{padding-left:10px;padding-right:10px;} }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold"><i class="bi bi-shop"></i> App de Vendas</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#" id="abaVendas"><i class="bi bi-cart2 me-1"></i> Vendas</a></li>
        <li class="nav-item"><a class="nav-link" href="#" id="abaEstoque"><i class="bi bi-box-seam me-1"></i> Estoque</a></li>
        <li class="nav-item"><a class="nav-link" href="#" id="abaHistorico"><i class="bi bi-clock-history me-1"></i> Hist√≥rico</a></li>
      </ul>
    </div>
  </nav>

  <div class="container mb-5">
    <div id="telaVendas">
      <div class="row">
        <div class="col-md-8">
          <h4 class="text-success mb-3"><i class="bi bi-bag"></i> Produtos</h4>
          <div id="lista-produtos" class="row g-3"></div>
        </div>
        <div class="col-md-4">
          <h4 class="text-success mb-3"><i class="bi bi-basket3"></i> Carrinho</h4>
          <ul id="lista-carrinho" class="list-group mb-3"></ul>
          <h5 class="text-end fw-bold text-success">Total: R$ <span id="totalVenda">0.00</span></h5>
          <button id="btnFinalizar" class="btn btn-success w-100 mt-2"><i class="bi bi-check2-circle"></i> Finalizar Venda</button>
        </div>
      </div>
    </div>

    <div id="telaEstoque" style="display:none;">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h4 class="mb-0 text-success"><i class="bi bi-box-seam"></i> Gest√£o de Estoque</h4>
            <button id="btnSairEstoque" class="btn btn-outline-secondary d-none mt-2 mt-md-0"><i class="bi bi-box-arrow-right"></i> Sair</button>
          </div>
          <div id="painelEstoqueArea" style="display:none;" class="mt-3">
            <div class="whatsapp-config">
              <label class="form-label"><i class="bi bi-whatsapp text-success"></i> WhatsApp do Gestor (com DDD)</label>
              <input id="whatsappGestor" class="form-control" type="tel" placeholder="Ex: 11987654321" value="">
              <small class="text-muted">As vendas ser√£o enviadas automaticamente para este n√∫mero</small>
            </div>
            <hr class="my-3">
            <form id="formNovoProduto" class="row g-3 align-items-end">
              <div class="col-md-4 col-12">
                <label class="form-label small">Nome do Produto</label>
                <input id="estoqueNome" class="form-control" placeholder="Ex: Camiseta" required>
              </div>
              <div class="col-md-2 col-6">
                <label class="form-label small">Quantidade</label>
                <input id="estoqueQuantidade" class="form-control" type="number" placeholder="Qtd" min="0" required>
              </div>
              <div class="col-md-2 col-6">
                <label class="form-label small">Pre√ßo (R$)</label>
                <input id="estoquePreco" class="form-control" type="number" placeholder="0.00" step="0.01" min="0" required>
              </div>
              <div class="col-md-3 col-12">
                <label class="form-label small">Imagem</label>
                <input id="estoqueImagem" class="form-control" type="file" accept="image/*">
              </div>
              <div class="col-md-1 col-12">
                <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-lg"></i></button>
              </div>
            </form>
            <hr class="my-3">
            <h6 class="small-muted mb-3"><i class="bi bi-boxes"></i> Produtos no estoque</h6>
            <div id="listaEstoque" class="row g-3"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="telaHistorico" style="display:none;">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="text-success mb-3"><i class="bi bi-clock-history"></i> Hist√≥rico de Vendas</h4>
          <div id="areaHistorico"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- modais -->
  <div class="modal fade" id="modalSenha" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-lock-fill"></i> Acesso Estoque</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input id="inputSenha" class="form-control" type="password" placeholder="Senha do gestor">
          <div id="senhaErro" class="text-danger mt-2" style="display:none;">Senha incorreta.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnConfirmarSenha" class="btn btn-success">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEditarProduto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-pencil-fill"></i> Editar Produto</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editarProdutoIdx">
          <div class="mb-3">
            <label class="form-label">Nome</label>
            <input id="editarNome" class="form-control" type="text">
          </div>
          <div class="mb-3">
            <label class="form-label">Quantidade</label>
            <input id="editarQuantidade" class="form-control" type="number" min="0">
          </div>
          <div class="mb-3">
            <label class="form-label">Pre√ßo (R$)</label>
            <input id="editarPreco" class="form-control" type="number" step="0.01" min="0">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnSalvarEdicao" class="btn btn-success">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEditarCarrinho" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-pencil-fill"></i> Editar Item</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editarCarrinhoIdx">
          <div class="mb-3">
            <label class="form-label fw-bold" id="editarCarrinhoNome"></label>
            <small class="text-muted d-block">R$ <span id="editarCarrinhoPreco">0.00</span></small>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantidade</label>
            <input id="editarCarrinhoQuantidade" class="form-control" type="number" min="1">
            <small class="text-muted" id="avisoEstoque"></small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnSalvarCarrinho" class="btn btn-success">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-sucesso" id="modalSucesso">
    <div class="modal-sucesso-content">
      <div class="check-animation"><i class="bi bi-check-lg"></i></div>
      <h4 id="tituloSucesso">Sucesso!</h4>
      <p id="mensagemSucesso"></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase + App logic -->
  <script type="module">
    // ---- Firebase SDK (modular, via CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
      onSnapshot, runTransaction, query, orderBy, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getStorage, ref as sref, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ===== CONFIG - usa a sua config que voc√™ passou
    const firebaseConfig = {
      apiKey: "AIzaSyDOOgPGQS6minWBynxF2D7AhGrlg8AM2-o",
      authDomain: "appvendas-1e0e1.firebaseapp.com",
      projectId: "appvendas-1e0e1",
      storageBucket: "appvendas-1e0e1.firebasestorage.app",
      messagingSenderId: "1049507415214",
      appId: "1:1049507415214:web:dbfe6f19447012e86c193f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---- Estado local em mem√≥ria (carrinho por sess√£o)
    const carrinho = []; // { id, nome, preco, qtd }
    let produtos = [];   // array local cache gerada via onSnapshot
    let whatsappGestor = ""; // vamos salvar configura√ß√£o no Firestore (doc config/global) quando usu√°rio setar

    const SENHA_GESTOR = 'sucesso2026';

    // ---------- UI helpers ----------
    function mostrarModalSucesso(titulo, mensagem){
      document.getElementById('tituloSucesso').textContent = titulo;
      document.getElementById('mensagemSucesso').textContent = mensagem;
      const el = document.getElementById('modalSucesso');
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 2500);
    }

    function formatBR(valor){ return Number(valor).toFixed(2).replace('.',','); }
    function safeNumber(v){ return Number(v || 0); }

    // ---------- Firestore listeners ----------
    // Produtos em tempo real (cole√ß√£o: "produtos")
    const produtosCol = collection(db, 'produtos');
    onSnapshot(produtosCol, (snap) => {
      produtos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // ordenar localmente por nome
      produtos.sort((a,b)=> (a.nome||'').localeCompare(b.nome||''));
      renderProdutos();
      renderEstoque();
    });

    // Hist√≥rico / vendas em tempo real (cole√ß√£o: "vendas")
    const vendasCol = query(collection(db, 'vendas'), orderBy('createdAt', 'desc'));
    onSnapshot(vendasCol, (snap) => {
      const vendas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderHistoricoFromDocs(vendas);
    });

    // Carrega config global (whatsapp gestor) - doc √∫nico em "config/global"
    const configDocRef = doc(db, 'config', 'global');
    onSnapshot(configDocRef, (snap) => {
      const data = snap.exists() ? snap.data() : {};
      whatsappGestor = data.whatsappGestor || '';
      const el = document.getElementById('whatsappGestor');
      if(el) el.value = whatsappGestor;
    });

    // ---------- Render UI ----------
    function renderProdutos(){
      const g = document.getElementById('lista-produtos');
      if(!g) return;
      g.innerHTML = '';
      if(produtos.length === 0){
        g.innerHTML = '<div class="col-12"><p class="text-muted">Nenhum produto cadastrado.</p></div>';
        return;
      }
      produtos.forEach((p, i) => {
        const img = p.imagemURL || 'https://via.placeholder.com/300x150?text=Sem+Imagem';
        const preco = Number(p.preco||0).toFixed(2);
        g.innerHTML += `<div class="col-12"><div class="card card-product shadow-sm p-2 mb-2"><div class="row align-items-center g-2"><div class="col-auto"><div class="img-side"><img src="${img}" alt="${p.nome}"></div></div><div class="col"><h6 class="mb-1">${p.nome}</h6><div class="small-muted">R$ <b>${Number(preco).toFixed(2)}</b> ‚Ä¢ Estoque: <span class="badge bg-success">${p.quantidade}</span></div></div><div class="col-auto"><div class="quantidade-controle mb-2"><button class="btn-menos" onclick="diminuirQtd(${i})">‚àí</button><input type="number" id="qtd-${i}" value="1" min="1"><button class="btn-mais" onclick="aumentarQtd(${i})">+</button></div><div><button class="btn-add" onclick="adicionarAoCarrinhoByIndex(${i})"><i class="bi bi-cart-plus"></i> Adicionar</button></div></div></div></div></div>`;
      });
    }

    function renderEstoque(){
      const l = document.getElementById('listaEstoque');
      if(!l) return;
      l.innerHTML = '';
      if(produtos.length === 0) {
        l.innerHTML = '<div class="col-12"><p class="text-muted text-center py-4">Nenhum produto cadastrado ainda.</p></div>';
        return;
      }
      produtos.forEach((p, idx) => {
        const img = p.imagemURL || 'https://via.placeholder.com/150x80?text=Sem+Imagem';
        l.innerHTML += `<div class="col-md-6 col-12"><div class="card card-estoque shadow-sm p-3"><div class="d-flex gap-3 align-items-center flex-wrap"><div class="img-estoque"><img src="${img}" alt="${p.nome}"></div><div class="estoque-info"><h6>${p.nome}</h6><div class="estoque-preco">R$ <b>${Number(p.preco||0).toFixed(2)}</b></div><div class="estoque-qtd">Estoque: <span class="badge bg-success">${p.quantidade}</span></div></div><div class="estoque-acoes ms-auto"><button class="btn-icon btn-edit" onclick="abrirEditar('${p.id}')" title="Editar"><i class="bi bi-pencil"></i></button><button class="btn-icon btn-delete" onclick="excluirProduto('${p.id}')" title="Excluir"><i class="bi bi-trash"></i></button></div></div></div></div>`;
      });
    }

    function renderHistoricoFromDocs(vendas){
      const a = document.getElementById('areaHistorico');
      if(!a) return;
      if(!vendas.length){
        a.innerHTML = '<p class="text-muted">Nenhuma venda registrada ainda.</p>';
        return;
      }
      a.innerHTML = '';
      vendas.forEach(v=>{
        const date = v.createdAt ? new Date(v.createdAt.seconds * 1000).toLocaleString('pt-BR') : (v.data || '');
        a.innerHTML += `<div class="mb-3 border rounded p-3 bg-light"><div class="small-muted"><b>Data:</b> ${date}</div><ul>${(v.itens||[]).map(i=>`<li>${i.nome} ‚Äî ${i.qtd} x R$ ${Number(i.preco).toFixed(2)}</li>`).join('')}</ul><div class="fw-bold text-success">Total: R$ ${Number(v.total||0).toFixed(2)}</div></div>`;
      });
    }

    // ---------- Carrinho (sess√£o) ----------
    function adicionarAoCarrinhoByIndex(i){
      const el = document.getElementById(`qtd-${i}`);
      let qtd = parseInt(el.value) || 1;
      if(qtd < 1) qtd = 1;
      const p = produtos[i];
      if(!p) { mostrarModalSucesso('Erro','Produto n√£o encontrado'); return; }
      if(p.quantidade < qtd){ mostrarModalSucesso('Ops!','Estoque insuficiente'); return; }
      // procura se j√° no carrinho
      const it = carrinho.find(x => x.id === p.id);
      if(it) it.qtd += qtd;
      else carrinho.push({ id: p.id, nome: p.nome, preco: Number(p.preco), qtd });
      mostrarModalSucesso('Adicionado!', `${qtd}x ${p.nome} adicionado ao carrinho`);
      renderCarrinho();
    }

    function renderCarrinho(){
      const l = document.getElementById('lista-carrinho');
      l.innerHTML = '';
      let t = 0;
      if(!carrinho.length){
        l.innerHTML = '<li class="list-group-item text-muted">Carrinho vazio.</li>';
      } else {
        carrinho.forEach((it, idx) => {
          const st = it.preco * it.qtd; t += st;
          l.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div style="min-width:0;"><b>${it.nome}</b><div class="small-muted">${it.qtd}x R$ ${Number(it.preco).toFixed(2)}</div></div><div class="d-flex align-items-center gap-2"><button class="btn-icon" onclick="abrirEditarCarrinho(${idx})" title="Editar quantidade" style="background:#0d6efd;color:#fff;"><i class="bi bi-pencil"></i></button><button class="btn-icon" onclick="removerDoCarrinho(${idx})" title="Remover" style="background:#dc3545;color:#fff;"><i class="bi bi-trash"></i></button><div class="fw-bold ms-2">R$ ${st.toFixed(2)}</div></div></li>`;
        });
      }
      document.getElementById('totalVenda').textContent = Number(t).toFixed(2);
    }

    function abrirEditarCarrinho(idx){
      const item = carrinho[idx];
      if(!item) return;
      document.getElementById('editarCarrinhoIdx').value = idx;
      document.getElementById('editarCarrinhoNome').textContent = item.nome;
      document.getElementById('editarCarrinhoPreco').textContent = item.preco.toFixed(2);
      document.getElementById('editarCarrinhoQuantidade').value = item.qtd;
      const produto = produtos.find(p=>p.id===item.id);
      if(produto) document.getElementById('avisoEstoque').textContent = `Estoque dispon√≠vel: ${produto.quantidade + item.qtd} unidade(s)`;
      new bootstrap.Modal(document.getElementById('modalEditarCarrinho')).show();
    }

    function removerDoCarrinho(idx){
      const item = carrinho[idx];
      if(!item) return;
      carrinho.splice(idx,1);
      renderCarrinho();
      mostrarModalSucesso('Removido', `${item.nome} removido do carrinho`);
    }

    // editar carrinho salvar
    document.getElementById('btnSalvarCarrinho').addEventListener('click', ()=>{
      const idx = parseInt(document.getElementById('editarCarrinhoIdx').value);
      const novaQtd = parseInt(document.getElementById('editarCarrinhoQuantidade').value) || 0;
      if(novaQtd < 1){ mostrarModalSucesso('Erro', 'A quantidade deve ser pelo menos 1'); return; }
      const item = carrinho[idx]; if(!item) return;
      const produto = produtos.find(p=>p.id === item.id);
      if(!produto){ mostrarModalSucesso('Erro', 'Produto n√£o encontrado'); return; }
      // Verifica estoque dispon√≠vel
      if(novaQtd > (produto.quantidade + item.qtd)){
        mostrarModalSucesso('Estoque insuficiente', `S√≥ restam ${produto.quantidade + item.qtd} unidade(s) em estoque`);
        return;
      }
      item.qtd = novaQtd;
      renderCarrinho();
      bootstrap.Modal.getInstance(document.getElementById('modalEditarCarrinho')).hide();
      mostrarModalSucesso('Atualizado!', `${item.nome}: ${novaQtd} unidade(s)`);
    });

    // ---------- Finalizar venda: transa√ß√£o at√¥mica ----------
    document.getElementById('btnFinalizar').addEventListener('click', async ()=>{
      if(!carrinho.length){ mostrarModalSucesso('Ops!','Carrinho vazio!'); return; }
      try {
        const total = carrinho.reduce((s,i)=>s + i.preco * i.qtd, 0);
        // execu√ß√£o em uma √∫nica transa√ß√£o: ler todos os produtos envolvidos, validar estoque, atualizar e criar venda
        await runTransaction(db, async (tx) => {
          // busca docs refs
          const refs = carrinho.map(it => doc(db,'produtos', it.id));
          const snaps = await Promise.all(refs.map(r => tx.get(r)));
          // valida estoque
          for(let i=0;i<carrinho.length;i++){
            const snap = snaps[i];
            const it = carrinho[i];
            if(!snap.exists()) throw new Error(`Produto ${it.nome} n√£o encontrado`);
            const current = snap.data().quantidade || 0;
            if(current < it.qtd) throw new Error(`Estoque insuficiente para ${it.nome}`);
          }
          // decrementa estoque
          for(let i=0;i<carrinho.length;i++){
            const it = carrinho[i];
            const ref = refs[i];
            const newQty = (snaps[i].data().quantidade || 0) - it.qtd;
            tx.update(ref, { quantidade: newQty });
          }
          // registra venda
          const vendaRef = doc(collection(db,'vendas'));
          tx.set(vendaRef, {
            itens: carrinho.map(c => ({ id: c.id, nome: c.nome, preco: c.preco, qtd: c.qtd })),
            total,
            createdAt: serverTimestamp()
          });
        });
        // transa√ß√£o conclu√≠da, limpar carrinho local
        const vendaTotal = carrinho.reduce((s,i)=>s + i.preco * i.qtd, 0);
        // envia whatsapp (pega n√∫mero do config global, se existir)
        const vendaObj = { data: new Date().toLocaleString('pt-BR'), itens: [...carrinho], total: vendaTotal };
        enviarWhatsApp(vendaObj);
        carrinho.length = 0;
        renderCarrinho();
        mostrarModalSucesso('Venda Conclu√≠da!', `Total: R$ ${vendaTotal.toFixed(2)}`);
      } catch (err){
        console.error(err);
        mostrarModalSucesso('Erro', err.message || 'Erro ao finalizar venda');
      }
    });

    // ---------- Estoque: adicionar / editar / excluir ----------
    document.getElementById('formNovoProduto').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nome = document.getElementById('estoqueNome').value.trim();
      const qtd = parseInt(document.getElementById('estoqueQuantidade').value) || 0;
      const preco = parseFloat(document.getElementById('estoquePreco').value) || 0;
      const imgFile = document.getElementById('estoqueImagem').files[0];
      if(!nome || qtd < 0 || preco <= 0){ mostrarModalSucesso('Erro!', 'Preencha todos os campos corretamente'); return; }
      try {
        let imagemURL = '';
        let storagePath = '';
        if(imgFile){
          const path = `produtos/${Date.now()}_${imgFile.name}`;
          const storageRef = sref(storage, path);
          await uploadBytes(storageRef, imgFile);
          imagemURL = await getDownloadURL(storageRef);
          storagePath = path;
        }
        await addDoc(collection(db,'produtos'), {
          nome, quantidade: qtd, preco, imagemURL, storagePath
        });
        e.target.reset();
        mostrarModalSucesso('Produto Adicionado!', `${nome} cadastrado com sucesso`);
      } catch (err){
        console.error(err);
        mostrarModalSucesso('Erro', 'Falha ao adicionar produto');
      }
    });

    // abrir editar (preenche modal) por id
    window.abrirEditar = function(prodId){
      const p = produtos.find(x=>x.id===prodId);
      if(!p) return;
      document.getElementById('editarProdutoIdx').value = p.id;
      document.getElementById('editarNome').value = p.nome;
      document.getElementById('editarQuantidade').value = p.quantidade;
      document.getElementById('editarPreco').value = p.preco;
      new bootstrap.Modal(document.getElementById('modalEditarProduto')).show();
    };

    document.getElementById('btnSalvarEdicao').addEventListener('click', async ()=>{
      const id = document.getElementById('editarProdutoIdx').value;
      const nome = document.getElementById('editarNome').value.trim();
      const quantidade = parseInt(document.getElementById('editarQuantidade').value) || 0;
      const preco = parseFloat(document.getElementById('editarPreco').value) || 0;
      if(!id) return;
      try {
        await updateDoc(doc(db,'produtos',id), { nome, quantidade, preco });
        bootstrap.Modal.getInstance(document.getElementById('modalEditarProduto')).hide();
        mostrarModalSucesso('Atualizado!', 'Produto editado com sucesso');
      } catch (err){
        console.error(err);
        mostrarModalSucesso('Erro', 'Falha ao editar produto');
      }
    });

    // excluir produto (remove doc e arquivo storage se houver)
    window.excluirProduto = async function(prodId){
      const p = produtos.find(x=>x.id===prodId);
      if(!p) return;
      if(!confirm(`Deseja realmente excluir "${p.nome}"?`)) return;
      try {
        // primeiro remove imagem no storage se houver storagePath
        if(p.storagePath){
          const fileRef = sref(storage, p.storagePath);
          try { await deleteObject(fileRef); } catch(e){ /* pode n√£o existir - ignora */ }
        }
        await deleteDoc(doc(db,'produtos',prodId));
        mostrarModalSucesso('Exclu√≠do!', 'Produto removido do estoque');
      } catch (err){
        console.error(err);
        mostrarModalSucesso('Erro', 'Falha ao excluir produto');
      }
    };

    // ---------- Editar carrinho UI (abrir editar produto) ----------
    window.abrirEditarCarrinho = abrirEditarCarrinho;

    // ---------- Navega√ß√£o das abas e senha estoque ----------
    function mostrarAba(nome){
      document.getElementById('telaVendas').style.display = nome==='vendas'?'':'none';
      document.getElementById('telaEstoque').style.display = nome==='estoque'?'':'none';
      document.getElementById('telaHistorico').style.display = nome==='historico'?'':'none';
      if(nome==='vendas'){ renderProdutos(); renderCarrinho(); }
      if(nome==='historico') {} // historico atualizado por listener
      if(nome==='estoque'){
        document.getElementById('painelEstoqueArea').style.display = '';
        renderEstoque();
      }
    }

    document.getElementById('abaVendas').addEventListener('click', ()=> mostrarAba('vendas'));
    document.getElementById('abaHistorico').addEventListener('click', ()=> mostrarAba('historico'));
    document.getElementById('abaEstoque').addEventListener('click', ()=>{
      new bootstrap.Modal(document.getElementById('modalSenha')).show();
    });

    document.getElementById('btnConfirmarSenha').addEventListener('click', async ()=>{
      const v = document.getElementById('inputSenha').value.trim();
      if(v === SENHA_GESTOR){
        // mostra painel estoque e carrega config global (whatsapp)
        bootstrap.Modal.getInstance(document.getElementById('modalSenha')).hide();
        document.getElementById('painelEstoqueArea').style.display = '';
        // mostrar aba estoque
        mostrarAba('estoque');
      } else {
        document.getElementById('senhaErro').style.display = 'block';
      }
    });

    document.getElementById('btnSairEstoque').addEventListener('click', ()=>{
      document.getElementById('painelEstoqueArea').style.display = 'none';
      mostrarAba('vendas');
    });

    // ---------- Whatsapp config save to Firestore ----------
    document.getElementById('whatsappGestor').addEventListener('change', async (e)=>{
      const val = e.target.value.trim().replace(/\D/g,'');
      try {
        await updateDoc(configDocRef, { whatsappGestor: val }).catch(async (err)=>{
          // se doc n√£o existir, cria
          await addDoc(collection(db,'config'), { whatsappGestor: val });
          // melhor path: set on doc with known id; we use updateDoc with known doc above - if missing we'll set:
          await updateDoc(configDocRef, { whatsappGestor: val }).catch(()=>{ /* ignore */});
        });
      } catch (err){
        // fallback: set the doc directly
        try { await updateDoc(configDocRef, { whatsappGestor: val }); } catch(e){ /* ignore */ }
      }
    });

    // ---------- enviar WhatsApp (usa whatsappGestor do config global) ----------
    function enviarWhatsApp(venda){
      // prefer config global, fallback para campo local
      let raw = (whatsappGestor || document.getElementById('whatsappGestor')?.value || '').toString();
      raw = raw.replace(/\s+/g,'').replace(/\D/g,'');
      if(!raw) return;
      let numero = raw.startsWith('55') ? raw : ('55' + raw);
      let mensagem = `üõí *NOVA VENDA REALIZADA*\n\n`;
      mensagem += `üìÖ Data: ${venda.data}\n\n`;
      mensagem += `üì¶ *Itens vendidos:*\n`;
      venda.itens.forEach(item => {
        mensagem += `‚Ä¢ ${item.nome} - ${item.qtd}x R$ ${Number(item.preco).toFixed(2)}\n`;
      });
      mensagem += `\nüí∞ *Total: R$ ${Number(venda.total).toFixed(2)}*`;
      const encoded = encodeURIComponent(mensagem);
      const webUrl = `https://wa.me/${numero}?text=${encoded}`;
      window.open(webUrl, '_blank');
    }

    // ---------- utilidades para aumentar/diminuir quantidade nos produtos UI ----------
    window.aumentarQtd = function(i){
      const e = document.getElementById(`qtd-${i}`);
      if(!e) return;
      e.value = parseInt(e.value || 0) + 1;
    };
    window.diminuirQtd = function(i){
      const e = document.getElementById(`qtd-${i}`);
      if(!e) return;
      const v = parseInt(e.value || 0);
      if(v > 1) e.value = v-1;
    };

    // ---------- inicial render (vazio - listeners populam) ----------
    renderProdutos();
    renderCarrinho();
    mostrarAba('vendas');

    // Expondo fun√ß√µes no escopo global que s√£o chamadas por atributos onclick no HTML
    window.adicionarAoCarrinhoByIndex = adicionarAoCarrinhoByIndex;
    window.removerDoCarrinho = removerDoCarrinho;
    window.abrirEditar = window.abrirEditar;
    window.excluirProduto = window.excluirProduto;
    window.abrirEditarCarrinho = abrirEditarCarrinho;
  </script>
</body>
</html>
